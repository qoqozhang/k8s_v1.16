---
title: pod调度到node的机制
date: 2019-12-05 13:08
tags: 
  - 
categories: 
  - 
---
>  你可能会遇到一些pod只能在一部分node上运行的情况,比如这个pod需要运行在SSD的node节点上这种情况，推荐使用`selector`选择器来选择pod的运行node。
# nodeSelector
在pod上使用`nodeSelector`来选择想要运行的node节点，必须是node上有的标签，不然会出现选择不到node的情况
1. 在node上添加标签 `kubectl label nodes <node-name> <label-key>=<label-value>`
2. 在pod上添加`nodeselector`，`.spec.container[*].nodeSelector`
# node内置标签
- `kubernetes.io/hostname`
- `failure-domain.beta.kubernetes.io/zone`
- `failure-domain.beta.kubernetes.io/region`
- `beta.kubernetes.io/instance-type`
- `kubernetes.io/os`
- `kubernetes.io/arch`
#  节点隔离和限制
当使用labels来选择pod可以运行的一组node节点的时候，这些被选择使用的labels 不建议使用kubelet程序来修改node上的标签。
但是`NodeRestriction` 插件允许kubelet 来修改设置以`node-restriction.kubernetes.io/`作为前缀的标签
# 亲和性和反亲和性
`nodeSelector` 的一些特点：
1. 支持更多表达式，不仅仅是AND 这种精确匹配
2. 也可以设置为 非硬性要求，如果调度没有匹配到，pod也会调度过去
3. 可以约束节点(或其他拓扑域)上运行的其他pods上的标签，而不是约束节点本身上的标签，这允许关于哪些pods可以和哪些pod不能共存的规则
## 节点亲和性 Node affinity
使用`nodeSelector`可以限制你的pod可以运行在哪些节点上，这里有两种类型的 node affinity，`requiredDuringSchedulingIgnoredDuringExecution`和`preferredDuringSchedulingIgnoredDuringExecution`.
`requiredDuringSchedulingIgnoredDuringExecution` 必须符合条件才会调度到节点上，和`nodeSelector`类似，但是规则更高级，`preferredDuringSchedulingIgnoredDuringExecution`会尝试强制调度，但是不保证成功。`IgnoredDuringExecution`这部分表示运行期间，如果node匹配的标签发生了变化，pod仍然会运行在原来的node节点上。`requiredDuringSchedulingRequiredDuringExecution`表示在pod运行期间，标签发生改变也会重新调度。
- `nodeSelector`和`nodeAffinity` 都存在，必须同时满足才会调度
- `nodeAffinity` 多个`nodeSelectorTerms`提供了