# kubernets组件

 ![Components of Kubernetes](https://d33wubrfki0l68.cloudfront.net/817bfdd83a524fed7342e77a26df18c87266b8f4/3da7c/images/docs/components-of-kubernetes.png) 

- 一个集群至少有一个node和一个master

- node部署pods，master管理node和pods，多个master提供了集群的高可用和容错

  

## master 组件

- kube-apiserver
  - 提供了管理的前端API
  - 支持横向扩展，部署多个kube-apiserver 负载
- etcd
  - 用于存储k8s集群的数据
  - 高可用，一致性
  - 建议做备份
- kube-schechuler
  - 执行pods的创建调度
- kube-controller-manager
  - master节点运行controller
  - controller是一个独立的程序
  - controller功能
    - node管理，发现和响应节点故障
    - 复制管理，相应和维护当前pods的数量
    - 对象管理，service和pod管理
    - 服务账号和Token管理，为新的namespace创建默认的账号和API访问token

## Node 组件

- kubelet
  - 运行在node上的一种agent
  - 仅管理通过多种机制创建的pods，监视通过pod创建的容器的状态。对非k8s创建的容器不做管理
- kube-proxy
  - 运行在node上的网络代理工具
  - 维护node上的网络规则，这些网络规则管理了pods的网络通信
  - 工作在包过滤层

- container runtime
  - 用于容器运行的软件，k8s支持docker，containered，cri-o，rktlet 

## 插件

使用这些插件可以丰富集群功能，插件工作在命名空间`kube-system`内。

- DNS
- Web UI (Dashboard)
- Container Resource Monitoring
- Cluster-level Logging

# API版本

1.  Alpha 		 v1alpha1 
2.  Beta  	       v2beta3 
3.  Stable  	     v11

# Node controller

node controller在 node生命周期种的作用：

1. node注册成功以后，分配一个CIDR给node；
2. controller内部的列表添加node；
3. 使用`NodeStatus`监视node的健康状态；

## 健康状态检查机制

​	1.13版本（包含1.13）之前使用 `NodeStatus` 监控node，从1.14版本开始默认使用 `Node lease `监控node。

​	当`node lease`启用以后，每个节点分配一个`Lease`对象在`kube-node-lease`命名空间中，周期性的更新节点状态，同时也会继续使用`NodeStatus`作为健康心跳。

​	`node lease` 会频繁的刷新状态给controller，而`NodeStatus` 只有在一些状态发生变化或者达到足够的时间(默认1分钟，使用` --node-monitor-period`配置时间)才会上报状态，如果`NodeStatus`在40秒之内没有收到应答则会把node设置为`ConditionUnknown`状态，5分钟以后把所有pods转移。

​	`node lease`比`NodeStatus`轻量级很多。
# Pods
## 什么是pods？
pods是k8s的最小可执行单元，pods就像集群的一个进程一样，每一个pods都是一个应用实例。
pod包含容器(一个或多个)，存储，唯一的网络IP等一系列容器运行需要的资源
## pods的两个主要用途
pods运行单一的容器，单容器的pods表示在pod里面仅运行一个容器。
pods运行多个容器共同工作，多个容器共享资源提供同一个服务。
## pods怎么管理多个容器
![](https://d33wubrfki0l68.cloudfront.net/aecab1f649bc640ebef1f05581bfcc91a48038c4/728d6/images/docs/pod.svg)
多容器的pod环境里面，这些容器共用**网络**和**存储**。
### 网络
    每一个pod都有一个唯一的网络IP地址，同一个pod里面的这些容器共用网络namespace，包括IP和端口，pod内的容器可以试用`localhost`访问其他容器。
### 存储
    每一个pod都可以使用共享的存储卷volume。同一个pod里面的容器共享volume，允许这些容器访问volume里面的数据。使用卷volume可以永久保存一个pod里面的数据。
## pod的状态
### status.phase 
`phase` 综合检测pod状态的概要。
`phase` 可能的几种状态：
- **Pending**：一个容器已经被k8是执行创建，但是当一个或多个容器的镜像还未下载创建好的状态；
- **Running**：当pod里面的容器已经都被创建好，且至少有一个容器已经是在运行中；
- **Succee